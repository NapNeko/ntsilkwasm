import type { FFmpegCoreVersion } from "../types";

const coreVersionRegExp = /^ffmpeg\sversion\s([^\s]+)/m;
const configurationRegExp = /^\s*configuration:\s(.+)$/m;
const libsRegExp = /^\s*(\w+)\s*(\d+)\.\s*(\d+)\.\s*(\d+)\s*\/.*$/gm;

export function parseVersion(output: string): FFmpegCoreVersion {
  return {
    version: output.match(coreVersionRegExp)?.[1] ?? "unknown",
    configuration: output.match(configurationRegExp)?.[1] ?? "",
    libs: Object.fromEntries(
      [...output.matchAll(libsRegExp)].map(([, name, major, minor, patch]) => [
        name as string,
        `${major as string}.${minor as string}.${patch as string}`,
      ]),
    ),
    raw: output,
  };
}
